<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breezy Weather</title>
  <link rel="icon" type="image/png" href="breezy-favicon.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { display: ["ui-rounded","SF Pro Display","Inter","system-ui","-apple-system","Segoe UI","Roboto","sans-serif"] },
          boxShadow: { glass: "0 10px 30px rgba(0,0,0,.25)" },
          backdropBlur: { xs: '2px' },
        }
      }
    }
  </script>
  <style>
    /* keep Safari from auto-resizing some lines on iPhone */
    html{ -webkit-text-size-adjust:100%; }

    .glass{background:rgba(255,255,255,.14);}
    .glass-dark{background:rgba(0,0,0,.22);}
    .text-shadow{ text-shadow: 0 2px 12px rgba(0,0,0,.45) }
    .hide-scroll::-webkit-scrollbar{ display:none }
    .hide-scroll{ -ms-overflow-style:none; scrollbar-width:none }

    /* ---------- WEEKLY (polished, centered emoji, unified fonts) ---------- */
    #daily{
      --row-text: 1.125rem;
      font-variant-numeric: tabular-nums;
      -webkit-font-smoothing: antialiased;
      font-family: inherit;
      overflow: hidden; /* never bleed past rounded card */
    }
    #daily .row{
      display:grid;
      grid-template-columns:
        12rem
        3rem
        6rem
        6rem
        14rem
        14rem;
      column-gap: 1.1rem;
      row-gap: .55rem;
      padding:1.1rem 1.4rem;
      border-bottom:1px solid rgba(255,255,255,.10);
      align-items:center;
      box-sizing:border-box;
      min-width:0;
    }
    #daily .row:last-child{border-bottom:0}
    #daily .date{
      padding-left:.35rem;
      padding-right:.25rem;
      font-size:var(--row-text);
      font-weight:600;
      letter-spacing:.01em;
      white-space:nowrap;
      min-width:0;
    }
    #daily .wx{
      place-self:center;
      font-size:2.15rem;
      line-height:1;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.15));
    }
    #daily .temp{
      display:flex; align-items:baseline; gap:.35rem;
      font-size:var(--row-text);
      font-weight:600;
      white-space:nowrap;
      min-width:0;
    }
    #daily .temp .label{ opacity:.95; }
    #daily .temp .value{ font-weight:600; }
    #daily .sun{
      display:flex; align-items:baseline; gap:.5rem;
      font-size:var(--row-text);
      white-space:nowrap;
      min-width:0;
    }
    #daily .sun .k{ font-weight:600; opacity:.95; }

    @media (max-width:640px){
      #daily .row{
        grid-template-columns:
          minmax(7.2rem,1fr)
          2.2rem
          minmax(3.9rem,.7fr)
          minmax(3.9rem,.7fr);
        column-gap:.5rem;
        row-gap:.35rem;
        padding:1rem .9rem;
      }
      #daily .wx{ font-size:2rem; }
      #daily .sun{ grid-column:1/-1; }
      #daily .sun + .sun{ margin-top:.15rem; }
    }

    /* ------------------------------------------------------------------ */
    /* ONLY THE TWO SECTIONS BELOW WERE CHANGED: Hourly tiles + Favorites */
    /* ------------------------------------------------------------------ */

    /* Hourly tiles ‚Äî same glass as cards, NO inner blur (prevents white/gray) */
    #hourly .tile{
      width:5.5rem;
      border-radius:1rem;
      padding:.65rem .25rem;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;
      text-shadow:0 1px 6px rgba(0,0,0,.35);
      -webkit-backdrop-filter:none !important;
      backdrop-filter:none !important;
    }
    #hourly .tile *{ color:inherit; }

    /* Favorites mini-cards ‚Äî same treatment (no blur, same glass) */
    .fav-card{
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;
      text-shadow:0 1px 6px rgba(0,0,0,.35);
      -webkit-backdrop-filter:none !important;
      backdrop-filter:none !important;
    }
    .fav-card *{ color:inherit; }
    /* ------------------------------------------------------------------ */
  </style>
</head>
<body class="min-h-screen text-white font-display selection:bg-white/20">
  <div id="sky" class="fixed inset-0 -z-10 transition-colors duration-700 bg-gradient-to-br from-sky-500 via-blue-600 to-indigo-700"></div>

  <div class="mx-auto max-w-5xl px-4 py-6 sm:px-6 lg:px-8">
    <header class="flex flex-col items-center gap-4">
      <img src="breezy-logo.png" alt="Breezy logo"
           class="h-32 w-auto select-none"
           onerror="this.style.display='none'"/>

      <div class="flex items-center gap-2">
        <button id="unitBtn" class="glass hover:bg-white/25 active:scale-95 transition rounded-2xl px-3 py-2 text-sm">¬∞F</button>
        <button id="themeBtn" class="glass hover:bg-white/25 active:scale-95 transition rounded-2xl px-3 py-2 text-sm">Theme</button>
        <button id="loginBtn" class="glass hover:bg-white/25 active:scale-95 transition rounded-2xl px-3 py-2 text-sm">Login</button>
        <a href="#about" class="glass hover:bg-white/25 rounded-2xl px-3 py-2 text-sm">About</a>
      </div>
    </header>

    <section class="mt-4">
      <div class="glass rounded-3xl p-2 shadow-glass backdrop-blur-xl">
        <div class="flex items-center gap-2">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="opacity-80"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input id="city" class="w-full bg-transparent outline-none placeholder-white/70 py-2" placeholder="Search city" />
          <button id="useGps" title="Use my location" class="glass hover:bg-white/25 rounded-2xl px-3 py-2">GPS</button>
          <button id="go" class="bg-white text-gray-900 rounded-2xl px-4 py-2 font-medium hover:opacity-90 active:scale-95 transition">Search</button>
        </div>
      </div>
      <p id="hint" class="mt-2 text-white/80 text-sm">Try: Indianapolis, Chicago, New York</p>
    </section>

    <section id="current" class="mt-6 grid gap-4 md:grid-cols-3">
      <div class="md:col-span-2 relative overflow-hidden rounded-3xl glass shadow-glass backdrop-blur-xl p-6">
        <div class="absolute inset-0 pointer-events-none opacity-30" id="animClouds"></div>
        <div class="flex items-end justify-between">
          <div>
            <div class="flex items-center gap-3">
              <div id="place" class="text-xl sm:text-2xl font-medium"></div>
              <button id="favBtn" title="Save to favorites"
                      class="text-2xl leading-none opacity-90 hover:opacity-100 select-none">‚ô°</button>
            </div>
            <div class="mt-1 text-white/80" id="dateNow"></div>
            <div class="mt-6 flex items-center gap-4">
              <div class="text-7xl sm:text-8xl leading-none" id="temp">--¬∞</div>
              <div class="space-y-1">
                <div id="summary" class="text-lg"></div>
                <div id="feels" class="text-white/80 text-sm"></div>
                <div id="hiLo" class="text-white/80 text-sm"></div>
              </div>
            </div>
          </div>
          <div id="bigIcon" class="text-7xl sm:text-8xl">‚òÄÔ∏è</div>
        </div>
      </div>

      <div class="rounded-3xl glass shadow-glass backdrop-blur-xl p-6" id="nowCard">
        <dl class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm">
          <div><dt class="opacity-80 font-semibold text-base">Wind</dt><dd id="wind" class="text-lg"></dd></div>
          <div><dt class="opacity-80 font-semibold text-base">Humidity</dt><dd id="humid" class="text-lg"></dd></div>
          <div><dt class="opacity-80 font-semibold text-base">Pressure</dt><dd id="press" class="text-lg"></dd></div>
          <div><dt class="opacity-80 font-semibold text-base">Visibility</dt><dd id="vis" class="text-lg"></dd></div>
        </dl>

        <!-- UV + Sunrise/Sunset -->
        <div class="mt-5 pt-4 border-t border-white/10">
          <div id="miniToday" class="grid grid-cols-3 gap-3 text-sm">
            <div class="rounded-xl bg-white/10 px-3 py-2 text-center">
              <div class="opacity-80 font-semibold text-xs uppercase tracking-wide">UV</div>
              <div id="uvNow" class="text-3xl sm:text-4xl font-semibold">--</div>
            </div>
            <div class="rounded-xl bg-white/10 px-3 py-2 text-center">
              <div class="opacity-80 font-semibold text-xs uppercase tracking-wide">Sunrise</div>
              <div id="sunrise" class="text-lg">--</div>
            </div>
            <div class="rounded-xl bg-white/10 px-3 py-2 text-center">
              <div class="opacity-80 font-semibold text-xs uppercase tracking-wide">Sunset</div>
              <div id="sunset" class="text-lg">--</div>
            </div>
          </div>
        </div>

        <div id="miniAlerts" class="mt-5 hidden">
          <div class="text-sm font-semibold mb-2">Alerts</div>
          <ul id="miniAlertsList" class="text-sm space-y-1"></ul>
          <a href="#alerts" class="inline-block mt-2 text-xs underline opacity-80">View all</a>
        </div>
      </div>
    </section>

    <section id="alerts" class="mt-6 hidden">
      <h2 class="mb-3 text-lg font-medium">Alerts</h2>
      <div id="alertsWrap" class="rounded-3xl glass shadow-glass backdrop-blur-xl divide-y divide-white/10"></div>
    </section>

    <section class="mt-6">
      <h2 class="mb-3 text-lg font-medium">Hourly</h2>
      <div class="relative">
        <button id="hourPrev" class="absolute left-2 top-1/2 -translate-y-1/2 z-10 glass hover:bg-white/25 rounded-full w-10 h-10 grid place-items-center" aria-label="Previous hours">‚Äπ</button>
        <div id="hourly"
             class="hide-scroll overflow-x-auto whitespace-nowrap rounded-3xl glass shadow-glass backdrop-blur-xl px-6 py-6 flex items-center scroll-smooth snap-x snap-mandatory">
          <div class="flex gap-5" id="hourRow"></div>
        </div>
        <button id="hourNext" class="absolute right-2 top-1/2 -translate-y-1/2 z-10 glass hover:bg-white/25 rounded-full w-10 h-10 grid place-items-center" aria-label="Next hours">‚Ä∫</button>
      </div>
    </section>

    <section class="mt-6">
      <h2 class="mb-3 text-lg font-medium">Weekly</h2>
      <div id="daily" class="rounded-3xl glass shadow-glass backdrop-blur-xl"></div>
    </section>

    <!-- Favorites -->
    <section id="favsSec" class="mt-6 hidden">
      <h2 class="mb-3 text-lg font-medium">Favorites</h2>
      <div class="relative">
        <button id="favPrev" class="absolute left-2 top-1/2 -translate-y-1/2 z-10 glass hover:bg-white/25 rounded-full w-10 h-10 grid place-items-center" aria-label="Previous favorites">‚Äπ</button>
        <div id="favsViewport" class="hide-scroll overflow-x-auto whitespace-nowrap rounded-3xl glass shadow-glass backdrop-blur-xl py-4 scroll-smooth">
          <div id="favsRow" class="px-4 flex gap-4"></div>
        </div>
        <button id="favNext" class="absolute right-2 top-1/2 -translate-y-1/2 z-10 glass hover:bg-white/25 rounded-full w-10 h-10 grid place-items-center" aria-label="Next favorites">‚Ä∫</button>
      </div>
    </section>

    <section class="mt-6" id="mapWrap">
      <h2 class="mb-3 text-lg font-medium">Map</h2>
      <div class="rounded-3xl glass shadow-glass backdrop-blur-xl overflow-hidden">
        <iframe id="radar"
          title="Radar"
          class="w-full"
          style="height: 28rem; border: 0;"
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
          src="">
        </iframe>
      </div>
    </section>

    <footer id="about" class="mt-10 pb-10 text-white/80 text-sm text-center">
      Data by Open-Meteo and Nominatim. <br>  Alisa Roberts Development 2025
    </footer>
  </div>

  <script>
    const cityEl = document.getElementById('city');
    const goBtn = document.getElementById('go');
    const gpsBtn = document.getElementById('useGps');
    const unitBtn = document.getElementById('unitBtn');

    let tempUnit = localStorage.getItem('unit') || 'fahrenheit';
    let lastLat = null, lastLon = null;

    const sky = document.getElementById('sky');
    const place = document.getElementById('place');
    const dateNow = document.getElementById('dateNow');
    const temp = document.getElementById('temp');
    const summary = document.getElementById('summary');
    const feels = document.getElementById('feels');
    const hiLo = document.getElementById('hiLo');
    const wind = document.getElementById('wind');
    const humid = document.getElementById('humid');
    const press = document.getElementById('press');
    const vis = document.getElementById('vis');
    const bigIcon = document.getElementById('bigIcon');
    const hourRow = document.getElementById('hourRow');
    const dailyWrap = document.getElementById('daily');

    const favsViewport = document.getElementById('favsViewport');
    const favsRow = document.getElementById('favsRow');
    const favPrevBtn = document.getElementById('favPrev');
    const favNextBtn = document.getElementById('favNext');

    const WMO = {
      0: ['Clear','‚òÄÔ∏è','from-sky-400 via-blue-600 to-indigo-700'],
      1: ['Mainly clear','üå§Ô∏è','from-sky-400 via-blue-600 to-indigo-700'],
      2: ['Partly cloudy','‚õÖ','from-sky-300 via-indigo-600 to-indigo-800'],
      3: ['Cloudy','‚òÅÔ∏è','from-slate-400 via-slate-600 to-slate-800'],
      45: ['Fog','üå´Ô∏è','from-slate-300 via-gray-500 to-gray-700'],
      48: ['Rime fog','üå´Ô∏è','from-slate-300 via-gray-500 to-gray-700'],
      51: ['Drizzle','üå¶Ô∏è','from-cyan-400 via-blue-600 to-blue-900'],
      61: ['Rain','üåßÔ∏è','from-cyan-500 via-blue-700 to-slate-900'],
      71: ['Snow','‚ùÑÔ∏è','from-sky-200 via-indigo-400 to-indigo-700'],
      80: ['Showers','üå¶Ô∏è','from-cyan-400 via-blue-700 to-slate-900'],
      95: ['Thunder','‚õàÔ∏è','from-indigo-700 via-purple-800 to-slate-900'],
    };

    function setSky(gradient){
      sky.className = `fixed inset-0 -z-10 transition-colors duration-700 bg-gradient-to-br ${gradient}`
    }
    function fmtTime(s){ return new Date(s).toLocaleTimeString([], {hour:'numeric'}); }
    function fmtDay(s){ return new Date(s).toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'}); }

    async function geocode(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers: { 'Accept-Language': 'en' }});
      const data = await res.json();
      if(!data.length) throw new Error('City not found');
      const { lat, lon, display_name } = data[0];
      return { lat:Number(lat), lon:Number(lon), name:display_name.split(',')[0] };
    }

    async function forecast(lat, lon){
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,pressure_msl,wind_speed_10m,visibility` +
        `&hourly=temperature_2m,weather_code` +
        `&daily=temperature_2m_max,temperature_2m_min,weather_code,sunrise,sunset,uv_index_max` +
        `&timezone=auto&temperature_unit=${tempUnit}`;
      const res = await fetch(url);
      return res.json();
    }

    async function getWarnings(lat, lon){
      const url = `https://api.open-meteo.com/v1/warnings?latitude=${lat}&longitude=${lon}&timezone=auto`;
      const res = await fetch(url);
      return res.json();
    }

    function updateMiniAlerts(list){
      const wrap = document.getElementById('miniAlerts');
      const ul = document.getElementById('miniAlertsList');
      if(!wrap || !ul) return;
      ul.innerHTML = '';
      if(!list || list.length === 0){ wrap.classList.add('hidden'); return; }
      wrap.classList.remove('hidden');
      list.slice(0,2).forEach(w => {
        const li = document.createElement('li');
        const title = w.event || 'Alert';
        const sev = w.severity ? ` ‚Ä¢ ${w.severity}` : '';
        li.textContent = `${title}${sev}`;
        ul.appendChild(li);
      });
    }

    function render(data, label){
      const now = new Date(data.current.time);
      dateNow.textContent = now.toLocaleString([], {weekday:'long', hour:'2-digit', minute:'2-digit'});
      place.textContent = label;

      const item = WMO[data.current.weather_code] || ['Weather','‚òÄÔ∏è','from-sky-400 via-blue-600 to-indigo-700'];
      setSky(item[2]);
      bigIcon.textContent = item[1];
      summary.textContent = item[0];
      temp.textContent = Math.round(data.current.temperature_2m) + '¬∞';
      feels.textContent = 'Feels like ' + Math.round(data.current.apparent_temperature) + '¬∞';
      hiLo.textContent = 'H ' + Math.round(data.daily.temperature_2m_max[0]) + '¬∞  L ' + Math.round(data.daily.temperature_2m_min[0]) + '¬∞';
      wind.textContent = Math.round(data.current.wind_speed_10m) + ' mph';
      humid.textContent = data.current.relative_humidity_2m + '%';
      press.textContent = Math.round(data.current.pressure_msl) + ' hPa';
      vis.textContent = Math.round(data.current.visibility/1000) + ' km';

      const uv = (data.daily.uv_index_max && data.daily.uv_index_max[0] != null) ? Math.round(data.daily.uv_index_max[0]) : '--';
      const sr0 = (data.daily.sunrise && data.daily.sunrise[0]) ? new Date(data.daily.sunrise[0]).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}) : '--';
      const ss0 = (data.daily.sunset && data.daily.sunset[0]) ? new Date(data.daily.sunset[0]).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}) : '--';
      document.getElementById('uvNow').textContent = uv;
      document.getElementById('sunrise').textContent = sr0;
      document.getElementById('sunset').textContent = ss0;

      /* Hourly tiles */
      hourRow.innerHTML = '';
      const nowIdx = data.hourly.time.findIndex(t => new Date(t) > now);
      for(let i=Math.max(0, nowIdx); i<nowIdx+12 && i<data.hourly.time.length; i++){
        const t = fmtTime(data.hourly.time[i]);
        const ic = (WMO[data.hourly.weather_code[i]]||['','‚òÄÔ∏è'])[1];
        const v = Math.round(data.hourly.temperature_2m[i]);
        const el = document.createElement('div');
        el.className = 'tile shrink-0 text-center snap-center';
        el.innerHTML =
          `<div class="text-sm opacity-90">${t}</div>
           <div class="text-2xl">${ic}</div>
           <div class="mt-1 text-lg">${v}¬∞</div>`;
        hourRow.appendChild(el);
      }

      /* Weekly rows */
      dailyWrap.innerHTML = '';
      for(let i=0;i<data.daily.time.length;i++){
        const day = i===0? 'Today' : fmtDay(data.daily.time[i]);
        const ic = (WMO[data.daily.weather_code[i]]||['','‚òÄÔ∏è'])[1];
        const hi = Math.round(data.daily.temperature_2m_max[i]);
        const lo = Math.round(data.daily.temperature_2m_min[i]);
        const sr = data.daily.sunrise?.[i] ? new Date(data.daily.sunrise[i]).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}) : '--';
        const ss = data.daily.sunset?.[i] ? new Date(data.daily.sunset[i]).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}) : '--';

        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML =
          `<div class="date">${day}</div>
           <div class="wx">${ic}</div>
           <div class="temp hi"><span class="label">H</span><span class="value">${hi}¬∞</span></div>
           <div class="temp lo"><span class="label">L</span><span class="value">${lo}¬∞</span></div>
           <div class="sun"><span>üåÖ</span><span class="k">Sunrise</span><span class="v">${sr}</span></div>
           <div class="sun"><span>üåá</span><span class="k">Sunset</span><span class="v">${ss}</span></div>`;
        dailyWrap.appendChild(row);
      }

      if(lastLat && lastLon) renderAlertsFor(lastLat, lastLon);
      updateFavoriteIcon();
    }

    async function renderAlertsFor(lat, lon){
      const sec = document.getElementById('alerts');
      const wrap = document.getElementById('alertsWrap');
      wrap.innerHTML = '';
      try{
        const a = await getWarnings(lat, lon);
        const list = a.warnings || [];
        updateMiniAlerts(list);
        if(list.length === 0){ sec.classList.add('hidden'); return; }
        sec.classList.remove('hidden');
        list.forEach(w => {
          const card = document.createElement('div');
          card.className = 'p-5';
          const level = w.severity || '';
          const title = w.event || 'Alert';
          const from = w.onset ? new Date(w.onset).toLocaleString() : '';
          const to = w.expires ? new Date(w.expires).toLocaleString() : '';
          card.innerHTML =
            '<div class="flex items-center justify-between">' +
              '<div class="text-base font-medium">' + title + '</div>' +
              '<span class="text-xs opacity-80">' + level + '</span>' +
            '</div>' +
            '<div class="mt-1 text-sm opacity-80">' + from + (to ? (' to ' + to) : '') + '</div>' +
            '<p class="mt-3 text-sm whitespace-pre-line">' + (w.description || '') + '</p>' +
            (w.instruction ? ('<p class="mt-2 text-sm font-medium">' + w.instruction + '</p>') : '');
          wrap.appendChild(card);
        });
        maybeNotify(list);
      }catch(e){
        sec.classList.add('hidden');
        updateMiniAlerts([]);
        console.log('warn error', e);
      }
    }

    async function runQuery(q){
      try{
        document.body.classList.add('cursor-wait');
        const g = await geocode(q);
        lastLat = g.lat; lastLon = g.lon;
        updateRadar(lastLat, lastLon);
        const data = await forecast(g.lat, g.lon);
        render(data, g.name);
        localStorage.setItem('lastCity', q);
      }catch(err){
        alert(err.message || 'Error');
      }finally{
        document.body.classList.remove('cursor-wait');
      }
    }

    goBtn.addEventListener('click', () => {
      if(cityEl.value.trim()) runQuery(cityEl.value.trim());
    });
    cityEl.addEventListener('keyup', e => { if(e.key==='Enter' && cityEl.value.trim()) runQuery(cityEl.value.trim()) });

    gpsBtn.addEventListener('click', () => {
      if(!navigator.geolocation) return alert('GPS not available');
      navigator.geolocation.getCurrentPosition(async pos => {
        try{
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          lastLat = lat; lastLon = lon;
          updateRadar(lat, lon);
          const data = await forecast(lat, lon);
          render(data, 'My location');
          renderAlertsFor(lat, lon);
        }catch(e){ alert('Could not get weather'); }
      }, () => alert('Please allow location access'));
    });

    document.getElementById('themeBtn').addEventListener('click', () => {
      document.body.classList.toggle('dark-theme');
      const cards = document.querySelectorAll('.glass');
      cards.forEach(c => c.classList.toggle('glass-dark'));
    });

    unitBtn.addEventListener('click', () => {
      tempUnit = tempUnit === 'fahrenheit' ? 'celsius' : 'fahrenheit';
      unitBtn.textContent = tempUnit === 'fahrenheit' ? '¬∞F' : '¬∞C';
      localStorage.setItem('unit', tempUnit);
      if(cityEl.value.trim()){
        runQuery(cityEl.value.trim());
      } else {
        const last = localStorage.getItem('lastCity');
        runQuery(last || 'Indianapolis');
      }
    });

    const last = localStorage.getItem('lastCity');
    unitBtn.textContent = tempUnit === 'fahrenheit' ? '¬∞F' : '¬∞C';
    runQuery(last || 'Indianapolis');

    function canNotify(){ return 'Notification' in window; }
    async function ensurePermission(){
      if(!canNotify()) return false;
      if(Notification.permission === 'granted') return true;
      if(Notification.permission === 'denied') return false;
      const p = await Notification.requestPermission();
      return p === 'granted';
    }
    async function maybeNotify(list){
      const severe = list.find(w => {
        const s = (w.severity || '').toLowerCase();
        const t = (w.event || '').toLowerCase();
        return s.includes('severe') || s.includes('extreme') || /tornado|flash flood|warning/.test(t);
      });
      if(!severe) return;
      if(await ensurePermission()){
        new Notification('Weather alert', { body: severe.event + ' in your area' });
      }
    }

    /* Hourly carousel controls */
    const hourlyViewport = document.getElementById('hourly');
    const prevBtn = document.getElementById('hourPrev');
    const nextBtn = document.getElementById('hourNext');

    function scrollStep(dir = 1) {
      const tile = 92;
      const per = Math.max(1, Math.floor(hourlyViewport.clientWidth / tile));
      hourlyViewport.scrollBy({ left: dir * per * tile, behavior: 'smooth' });
    }
    prevBtn.addEventListener('click', () => scrollStep(-1));
    nextBtn.addEventListener('click', () => scrollStep(1));

    let isDown = false, startX = 0, startScroll = 0;
    hourlyViewport.addEventListener('pointerdown', e => {
      isDown = true;
      hourlyViewport.setPointerCapture(e.pointerId);
      startX = e.clientX;
      startScroll = hourlyViewport.scrollLeft;
    });
    hourlyViewport.addEventListener('pointermove', e => {
      if (!isDown) return;
      const dx = e.clientX - startX;
      hourlyViewport.scrollLeft = startScroll - dx;
    });
    ['pointerup','pointercancel','pointerleave'].forEach(evt =>
      hourlyViewport.addEventListener(evt, () => { isDown = false; })
    );

    function updateRadar(lat, lon){
      const frame = document.getElementById('radar');
      if(!frame) return;
      const url =
        `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}` +
        `&zoom=7&level=surface&overlay=radar&menu=&message=true` +
        `&marker=true&calendar=now&pressure=true&type=map` +
        `&location=coordinates&detail=true&detailLat=${lat}&detailLon=${lon}` +
        `&metricWind=mph&metricTemp=%C2%B0F`;
      frame.src = url;
    }

    /* =========================
       Auth + Favorites (Front-end only)
       ========================= */
    function openLoginModal(mode='login'){
      modalMode = mode;
      updateModalMode();
      document.getElementById('loginModal').style.display = 'flex';
    }
    function closeLoginModal(){
      document.getElementById('loginModal').style.display = 'none';
    }

    function getUsers(){
      try { return JSON.parse(localStorage.getItem('breezyUsers')||'{}'); }
      catch { return {}; }
    }
    function saveUsers(map){ localStorage.setItem('breezyUsers', JSON.stringify(map)); }

    function currentUserEmail(){
      return sessionStorage.getItem('breezySession') || localStorage.getItem('breezySession') || null;
    }
    function setSession(email, remember){
      if(remember){
        localStorage.setItem('breezySession', email);
        sessionStorage.removeItem('breezySession');
      }else{
        sessionStorage.setItem('breezySession', email);
        localStorage.removeItem('breezySession');
      }
    }
    function clearSession(){
      sessionStorage.removeItem('breezySession');
      localStorage.removeItem('breezySession');
    }
    function isSignedIn(){ return !!currentUserEmail(); }

    function favKey(){ return 'breezy:favs:' + (currentUserEmail() || ''); }
    function getFavs(){
      if(!isSignedIn()) return [];
      try { return JSON.parse(localStorage.getItem(favKey()) || '[]'); }
      catch { return []; }
    }
    function saveFavs(f){ localStorage.setItem(favKey(), JSON.stringify(f)); }

    function inFavorites(name){
      const f = getFavs();
      return f.some(x => (x.name || '').toLowerCase() === (name || '').toLowerCase());
    }
    function saveFavorite(name, lat, lon){
      if(!isSignedIn()) return;
      const f = getFavs();
      if(!inFavorites(name)){
        f.push({ name, lat, lon });
        saveFavs(f);
      }
    }
    function removeFavorite(name){
      if(!isSignedIn()) return;
      const f = getFavs().filter(x => x.name.toLowerCase() !== name.toLowerCase());
      saveFavs(f);
    }

    function updateFavoriteIcon(){
      const btn = document.getElementById('favBtn');
      if(!btn) return;
      const nm = place.textContent || '';
      const saved = isSignedIn() && inFavorites(nm);
      btn.textContent = saved ? '‚ô•' : '‚ô°';
      btn.title = saved ? 'Remove from favorites' : 'Save to favorites';
      btn.style.opacity = isSignedIn() ? '0.95' : '0.55';
    }

    async function fillFavCard(card, fav){
      try{
        const data = await forecast(fav.lat, fav.lon);
        const icon = (WMO[data.current.weather_code] || ['','‚òÄÔ∏è'])[1];
        const t = Math.round(data.current.temperature_2m);
        const time = new Date(data.current.time).toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
        card.querySelector('.fav-icon').textContent = icon;
        card.querySelector('.fav-temp').textContent = t + '¬∞';
        card.querySelector('.fav-time').textContent = time;
      }catch(e){}
    }

    function renderFavorites(){
      const sec = document.getElementById('favsSec');
      if(!isSignedIn()){
        sec.classList.add('hidden');
        if(favsRow) favsRow.innerHTML = '';
        return;
      }
      const favs = getFavs();
      if(favs.length === 0){
        sec.classList.add('hidden');
        if(favsRow) favsRow.innerHTML = '';
        return;
      }
      sec.classList.remove('hidden');
      favsRow.innerHTML = '';

      favs.forEach((fav) => {
        const card = document.createElement('div');
        /* removed bg-white/10 and backdrop-blur-xl ‚Äî fav-card CSS handles look */
        card.className = 'fav-card shrink-0 w-44 rounded-2xl p-4 select-none cursor-pointer';
        card.setAttribute('role','button');
        card.setAttribute('tabindex','0');
        card.dataset.name = fav.name;
        card.dataset.lat = fav.lat;
        card.dataset.lon = fav.lon;
        card.innerHTML =
          `<div class="mb-1 text-base font-semibold opacity-95 truncate">${fav.name}</div>
           <div class="flex items-center">
             <div class="fav-icon text-6xl leading-none">‚òÄÔ∏è</div>
             <div class="ml-auto text-right">
               <div class="fav-temp text-3xl leading-tight">--¬∞</div>
               <div class="fav-time text-xs opacity-80 mt-1"></div>
             </div>
           </div>`;
        card.addEventListener('click', () => openFavCard(card));
        favsRow.appendChild(card);
        fillFavCard(card, fav);
      });

      requestAnimationFrame(() => {
        if(!favsViewport) return;
        const needsNav = favsViewport.scrollWidth > favsViewport.clientWidth + 4;
        favPrevBtn.style.display = needsNav ? '' : 'none';
        favNextBtn.style.display = needsNav ? '' : 'none';
      });
    }

    async function openFavCard(card){
      const nm = card.dataset.name || '';
      const lat = parseFloat(card.dataset.lat);
      const lon = parseFloat(card.dataset.lon);
      if(!isFinite(lat) || !isFinite(lon)) return;
      lastLat = lat; lastLon = lon;
      updateRadar(lat, lon);
      try{
        const data = await forecast(lat, lon);
        render(data, nm);
        renderAlertsFor(lat, lon);
      }catch(e){
        alert('Could not load favorite.');
      }
    }
    document.addEventListener('click', (e) => {
      const card = e.target.closest('.fav-card');
      if(card) openFavCard(card);
    });
    document.addEventListener('keydown', (e) => {
      if(!(e.key === 'Enter' || e.key === ' ')) return;
      const card = e.target.closest('.fav-card');
      if(card){ e.preventDefault(); openFavCard(card); }
    });

    document.getElementById('favBtn').addEventListener('click', () => {
      if(!isSignedIn()){
        openLoginModal('login');
        return;
      }
      const nm = place.textContent || '';
      if(!nm || lastLat==null || lastLon==null) return;
      if(inFavorites(nm)){ removeFavorite(nm); } else { saveFavorite(nm, lastLat, lastLon); }
      updateFavoriteIcon();
      renderFavorites();
    });

    const loginBtn = document.getElementById('loginBtn');
    loginBtn.addEventListener('click', () => {
      if(isSignedIn()){
        clearSession();
        updateAuthUI();
        renderFavorites();
        updateFavoriteIcon();
      }else{
        openLoginModal('login');
      }
    });

    function updateAuthUI(){
      loginBtn.textContent = isSignedIn() ? 'Logout' : 'Login';
    }

    let modalMode = 'login';
    function updateModalMode(){
      const title = document.getElementById('loginTitle');
      const action = document.getElementById('loginAction');
      const toggle = document.getElementById('toggleCreate');
      title.textContent = (modalMode === 'create') ? 'Create your account' : 'Sign in to save your favorite locations';
      action.textContent = (modalMode === 'create') ? 'Create account' : 'Login';
      toggle.innerHTML = (modalMode === 'create')
        ? 'Already have an account? <a href="#" id="toLogin">Sign in</a>'
        : 'Don‚Äôt have an account? <a href="#" id="toCreate">Create account</a>';
      setTimeout(() => {
        const toCreate = document.getElementById('toCreate');
        const toLogin = document.getElementById('toLogin');
        if(toCreate) toCreate.addEventListener('click', (e)=>{ e.preventDefault(); modalMode='create'; updateModalMode(); });
        if(toLogin) toLogin.addEventListener('click', (e)=>{ e.preventDefault(); modalMode='login'; updateModalMode(); });
      }, 0);
    }

    async function handleLogin(){
      const email = (document.getElementById('loginEmail').value || '').trim().toLowerCase();
      const pass  = (document.getElementById('loginPass').value || '').trim();
      const remember = document.getElementById('loginRemember').checked;
      if(!email || !pass){ alert('Please enter email and password.'); return; }

      const users = getUsers();
      if(modalMode === 'create'){
        if(users[email]){ alert('Account already exists. Sign in instead.'); return; }
        users[email] = { password: pass, createdAt: Date.now() };
        saveUsers(users);
        setSession(email, remember);
        closeLoginModal();
        updateAuthUI();
        renderFavorites();
        updateFavoriteIcon();
        return;
      }
      if(!users[email] || users[email].password !== pass){
        alert('Invalid email or password.');
        return;
      }
      setSession(email, remember);
      closeLoginModal();
      updateAuthUI();
      renderFavorites();
      updateFavoriteIcon();
    }

    function favScrollStep(dir=1){
      if(!favsViewport) return;
      const first = favsRow.firstElementChild;
      const cardWidth = first ? first.getBoundingClientRect().width : 176;
      const gap = 16;
      const step = Math.max(1, Math.floor(favsViewport.clientWidth / (cardWidth + gap)));
      favsViewport.scrollBy({ left: dir * step * (cardWidth + gap), behavior: 'smooth' });
    }
    favPrevBtn.addEventListener('click', () => favScrollStep(-1));
    favNextBtn.addEventListener('click', () => favScrollStep(1));

    if (favsViewport){
      let down=false, startX=0, startScroll=0;
      favsViewport.addEventListener('pointerdown', e => {
        down=true; favsViewport.setPointerCapture(e.pointerId);
        startX=e.clientX; startScroll=favsViewport.scrollLeft;
      });
      favsViewport.addEventListener('pointermove', e => {
        if(!down) return;
        favsViewport.scrollLeft = startScroll - (e.clientX - startX);
      });
      ['pointerup','pointercancel','pointerleave'].forEach(evt =>
        favsViewport.addEventListener(evt, () => { down=false; })
      );
    }

    function updateAuthUI(){
      loginBtn.textContent = isSignedIn() ? 'Logout' : 'Login';
    }
    updateAuthUI();
    renderFavorites();
  </script>

  <!-- Login Modal -->
  <div id="loginModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7); align-items:center; justify-content:center;">
    <div style="background:white; color:black; padding:2rem; border-radius:1rem; width:90%; max-width:420px; box-shadow:0 10px 40px rgba(0,0,0,0.5); position:relative;">
      <span onclick="closeLoginModal()" style="position:absolute; top:1rem; right:1rem; cursor:pointer; font-size:1.5rem;">&times;</span>
      <h2 id="loginTitle" style="font-size:1.25rem; margin-bottom:0.75rem;">Sign in to save your favorite locations</h2>
      <p style="margin-bottom:1rem;">Save favorite places and sync them across devices.</p>
      <input id="loginEmail" type="email" placeholder="Email"
             style="width:100%; padding:0.6rem; margin-bottom:0.75rem; border:1px solid #ccc; border-radius:0.5rem;">
      <input id="loginPass" type="password" placeholder="Password"
             style="width:100%; padding:0.6rem; margin-bottom:0.75rem; border:1px solid #ccc; border-radius:0.5rem;">
      <label style="display:flex; align-items:center; margin-bottom:0.75rem; font-size:0.9rem;">
        <input id="loginRemember" type="checkbox" style="margin-right:0.5rem;"> Remember me on this device
      </label>
      <button id="loginAction" onclick="handleLogin()"
              style="width:100%; padding:0.75rem; background:#3b82f6; color:white; border:none; border-radius:0.5rem;">Login</button>
      <p id="toggleCreate" style="text-align:center; margin-top:1rem;">
        Don‚Äôt have an account? <a href="#" id="toCreate">Create account</a>
      </p>
    </div>
  </div>
</body>
</html>
